# 4장

## 데이터베이스 관리 패턴

> MSA에서는 분산 데이터베이스를 권장합니다. → **`약한 결합`**
> 

`분산 데이터베이스란 데이터베이스를 여러 노드로 분산시켜서 사용성, 성능을 극대화 시킨 데이터베이스`

참고 사이트: [https://dataonair.or.kr/db-tech-reference/d-guide/sql/?mod=document&uid=336](https://dataonair.or.kr/db-tech-reference/d-guide/sql/?mod=document&uid=336)

### 고려할 문제 3가지

데이터 배치 모델, 동기화, 데이터 결합

### 데이터 배치 패턴

약한 결합을 통해 각 서비스들의 유지 및 보수가 용이하도록 구성해야 합니다.

- 여러 서비스들이 모여서 하나의 애플리케이션을 이루기 때문에 서로가 강하게 연결되어 있다면, 하나의 서비스는 다양한 영역에 영향을 줄 수 있습니다.

이러한 아키텍처를 만들기 위해 `서비스별 데이터베이스` 라는 배치 패턴이 추천 됩니다.

### 서비스별 데이터베이스

서비스별 데이터베이스는 말 그대로, 하나의 서비스는 하나의 데이터베이스를 갖는 일대일로 매칭이 되는 것을 말합니다. 

`장점`

- 유연하고 빠르게 애플리케이션 변경
- 각 서비스에 맞는 DB 적용 가능

`단점`

- DB간 동기화 구조 설계가 어려움

### 공유 데이터베이스

MSA에서 이상적인 데이터베이스 모델은 서비스별 데이터베이스 모델이긴 하지만, 데이터베이스 동기화를 위해 분산 트랜잭션이 권장되지 않기 때문에 사용되는 모델입니다.

하나의 디비 안에 다양한 도메인의 테이블이 존재하는 구조이기 때문에 데이터의 일관성이 보장되지만, 데이터 변경 시 비관적 락을 걸어야 하기 때문에 순차적인 처리가 될 것이고 확장성에서 단점이 있습니다.

> 비관적 락 vs 낙관적 락 ([https://unluckyjung.github.io/db/2022/03/07/Optimistic-vs-Pessimistic-Lock/](https://unluckyjung.github.io/db/2022/03/07/Optimistic-vs-Pessimistic-Lock/))
> 

## SAGA 패턴

> 분산 트랜잭션 없이 로컬 트랜잭션 이벤트와 보상 트랜잭션을 활용한 디자인 패턴
> 
- 로컬 트랜잭션마다 시퀀스를 가지고 데이터 일관성 보장

![](/images/4.1~4.3/1.png)

### `코레오그래피` vs `오케스트레이션`

- 중재자의 유무
- 서비스의 복잡성에 따라

### 코레오그래피

코레오그래피는 SAGA 패턴 내에 존재하는 서비스들이 메시지 브로커를 통해 이벤트를 주고 받으면서 사가가 진행되는 것을 말합니다. 

중재자가 따로 없으므로, 각 서비스는 본인에게 영향이 있는 서비스를 구독해야 하고 비동기적으로 이벤트 브로커를 통해 교환을 합니다.

`장점`

- 단순함, 느슨한 결합

`단점`

- 느슨하게 결합되지만 서비스가 복잡해지면 결합이 강해질 수 있습니다.
    - 영향을 주는 이벤트가 증가할수록 구독하는 서비스가 증가
- 사가가 다양한 곳에서 정의되어 있어서 파악이 어려움

### 오케스트레이션

중재자가 서비스와 통신을 하며, SAGA 단계 작업이 완료되면 그 다음 단계를 진행할 서비스를 중재자가 직접 결정합니다. 

중재자만 각 서비스에 의존하므로, 서비스들 간에는 의존성이 없어서 구조가 비교적 단순하지만 중재자는 어떤 순서로 서비스가 실행될지 알고 있어야 합니다.

![](/images/4.1~4.3/2.png)

`장점`

- 중재자가 존재하고, 해당 위치에 사가가 정의되어 있어 파악이 용이함
- 중재자만 서비스를 알면 되기 때문에 의존 관계가 단순하고, 결합도가 매우 낮음