## 트랜잭셔널 메시징 패턴

> SAGA에서 발생한 이벤트 처리가 완료되면 메시지 발행과, 동시에 데이터 처리도 원자적으로 이루어져야합니다.
> 

한마디로, 트랜잭셔널 메시징 패턴은 SAGA에서 어떤 하나의 SAGA 이벤트가 완료되면, 완료했다는 이벤트와 DB를 업데이트 하는 메시지를 발행하게 되는데 이 메시지 전송까지 하나의 트랜잭션으로 묶는 것을 말합니다.

만일, 이벤트는 완료돼서 다음 SAGA 단계로 넘어갔는데 DB 업데이트가 되지 않았다면 서비스가 정상작동하는 것이 아니기 때문에 원자성을 지키기 위한 장치라고 볼 수 있습니다.

### 트랜잭셔널 아웃박스

- 트랙잭셔널 메시징을 구성하는 패턴 중 하나

![](/images/4.1~4.3/3.png)

서비스는 DB 업데이트 트랜잭션에 메시지를 포함시켜서 OUTBOX 테이블에 넣습니다. 그 후에, 메시지 릴레이가 읽고 메시지 브로커에게 발행하게 됩니다.

## OUTBOX 내의 메시지 얻기

### 폴링 퍼블리셔

메시지 릴레이가 OUTBOX 테이블을 지속적으로 폴링하는 것을 말합니다. 

주기적으로 릴레이가 DB를 폴링하게 되면 비용이 발생하기 때문에 규모가 작을 경우에 사용하는 것이 좋습니다.

그리고 OUTBOX 테이블을 읽기 때문에 추가적인 유지 보수가 필요합니다.

### 트랜잭션 로그 테일링

트랜잭션 로그 테일링은 OUTBOX 테이블 대신 DBMS 자체에 기록되는 로그 데이터를 `로그마이너` 라는 메시지 릴레이로 읽어와서 트랜잭션을 연결합니다.

DBMS가 직접관리해주는 로그를 읽어오기 때문에 OUTBOX 유지보수에 비용이 들지 않지만, DBMS에 대한 이해가 뒷밤치 되어야 하므로, 러닝커브가 존재합니다.

![](/images/4.1~4.3/4.png)

### 참고

[https://thebook.io/007035](https://thebook.io/007035)

[https://johngrib.github.io/wiki/saga/](https://johngrib.github.io/wiki/saga/)